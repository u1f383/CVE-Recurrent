FROM ubuntu:18.04
MAINTAINER u1f383

# apt-cache showpkg <package> -> show package version
# software-properties-common -> install PPA

RUN apt update
RUN DEBIAN_FRONTEND="noninteractive" TZ="Asia/Taipei" apt-get -yq install tzdata
RUN apt install -yq apache2=2.4.29-1ubuntu4.14 &&\
    apt install -yq software-properties-common &&\
    yes '' | add-apt-repository -y ppa:ondrej/php &&\
    apt update &&\
    apt install -yq php7.3 &&\
    apt install -yq php7.3-imagick &&\
    apt install -yq php7.3-mysql &&\
    apt install -yq php7.3-gd

RUN apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8 &&\
    add-apt-repository "deb [arch=amd64,arm64,ppc64el] http://mariadb.mirror.liquidtelecom.com/repo/10.4/ubuntu $(lsb_release -cs) main" &&\
    apt update &&\
    apt install -yq mariadb-server
# for ip addr
RUN apt install -yq iproute2 &&\
    apt install -yq vim

COPY dir.conf /etc/apache2/mods-enabled/dir.conf
COPY apache2.conf /etc/apache2/apache2.conf
COPY php7.3.conf /etc/apache2/mods-available/php7.3.conf
COPY php.ini /etc/php/7.3/apache2/php.ini 
COPY init.sql /init.sql
COPY wordpress /var/www/html/wordpress
# /etc/init.d/apache2 <cmd>

RUN mkdir -p /var/run/mysqld
RUN chown -R mysql:root /var/run/mysqld/

ENV APACHE_RUN_USER  www-data
ENV APACHE_RUN_GROUP www-data
ENV APACHE_LOG_DIR   /var/log/apache2
ENV APACHE_PID_FILE  /var/run/apache2/apache2.pid
ENV APACHE_RUN_DIR   /var/run/apache2
ENV APACHE_LOCK_DIR  /var/lock/apache2
ENV APACHE_LOG_DIR   /var/log/apache2

RUN usermod -u 1000 www-data
RUN usermod -G staff www-data
RUN chown -R www-data:www-data /var/www
EXPOSE 80

CMD mysqld & sleep 3 && mysql -uroot -pmeow < /init.sql && /usr/sbin/apache2 -D FOREGROUND
